---
{"dg-publish":true,"permalink":"/docs/지연시간 극복 {swjungle}{recre}/","title":"지연시간 극복 {swjungle}{recre}"}
---

- [[docs/week14-18 {swjungle}{my own weapon}{nestjs, socketio}\|week14-18 {swjungle}{my own weapon}{nestjs, socketio}]]
---
- 지연시간을 끊임없이 계산하는 요즘 게임처럼 구현할 정도는 아니지 않을까? 
- start_game호스트 이벤트를 받으면 3초의 시간여유 사이에 한 번만 브로드캐스트를 돌려 모든 응답이 돌아올때까지의 시간을 측정하는 것이다. 
- 지금 이미 서버는 플레이어들에게 `start_game` 브로드캐스트를 보내는데, 여기에 대한 `im_ready` 메시지를 플레이어들이 일괄적으로 보내도록 해보자. `RedGreenGame`엔티티에 `start_at`이라는 속성과 `ping`이라는 속성을 추가, `im_ready` 메시지를 받을때 `ping`을 그때그때 갱신한다.
- [web socket latency 관련 블로그](https://ankitbko.github.io/blog/2022/06/websocket-latency/) 에서는 클라이언트가 스스로 지연시간을 측정한다. 생각해보면 게임을 할때 클라이언트 화면 위에 지연시간이 뜨는게 맞기는 한듯. 

생각해본 api들이다.

```
// server -> player
ping: {
	server_ts: number
}

// player -> server
ping.ack: {
	server_ts: number,
	client_ts: number
}

// server -> player
pong: {
	server_ts: number,
	client_ts: number,
	server_ack_ts: number
}
```

수상할정도로 지연시간이 크게 나온다. 다음은 지연시간 계산결과를 측정한 뒤 각종 통계를 내본 결과다. 통계내는 numpy 코드는 GPT한테 부탁했다.

```
평균: 67.1118869296637ms
최소: 5.526527002512012ms
최대: 348.7045019865036ms
99% 백분위수: 200.6986215996742ms
95% 백분위수: 124.32711260021168ms
```

아래는 EC2에 올려서 IMDB를 사용했을때 결과

```
평균: 59.65141448760648ms
최소: 0.4221919924020767ms
최대: 405.82011999189854ms
99% 백분위수: 179.18522739261363ms
95% 백분위수: 115.07675500215555ms
```

## 1 way latency

생각해보니까, 위의 블로그가 소개해준 지연시간은 서버 - 플레이어 - 서버 - 플레이어 3-way 이벤트에 걸리는 시간을 측정한 거고, 플레이어가 run 요청을 쏴서 서버가 받기까지의 시간이 우리가 익히 아는 지연시간이었다.

<style> .container {font-family: sans-serif; text-align: center;} .button-wrapper button {z-index: 1;height: 40px; width: 100px; margin: 10px;padding: 5px;} .excalidraw .App-menu_top .buttonList { display: flex;} .excalidraw-wrapper { height: 800px; margin: 50px; position: relative;} :root[dir="ltr"] .excalidraw .layer-ui__wrapper .zen-mode-transition.App-menu_bottom--transition-left {transform: none;} </style><script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.production.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@excalidraw/excalidraw@0/dist/excalidraw.production.min.js"></script><div id="Drawing_2023-12-05_1924.48.excalidraw.md1"></div><script>(function(){const InitialData={"type":"excalidraw","version":2,"source":"https://github.com/zsviczian/obsidian-excalidraw-plugin/releases/tag/2.7.5","elements":[{"type":"line","version":164,"versionNonce":2073722826,"isDeleted":false,"id":"zNEGRCDad08vL28_A9A91","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-483.31985478293717,"y":-306.5552137382774,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":0.4682050427290587,"height":345.4857547627121,"seed":1424925816,"groupIds":[],"frameId":null,"roundness":{"type":2},"boundElements":[],"updated":1736852108450,"link":null,"locked":false,"startBinding":null,"endBinding":null,"lastCommittedPoint":null,"startArrowhead":null,"endArrowhead":null,"points":[[0,0],[0.4682050427290587,345.4857547627121]],"index":"a0"},{"type":"line","version":307,"versionNonce":19249622,"isDeleted":false,"id":"GTRjxx9VdNQ0cnXjRgmuX","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-248.93673413970026,"y":-303.89658162273315,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":0.4682050427290587,"height":345.4857547627121,"seed":1691117688,"groupIds":[],"frameId":null,"roundness":{"type":2},"boundElements":[],"updated":1736852108450,"link":null,"locked":false,"startBinding":null,"endBinding":null,"lastCommittedPoint":null,"startArrowhead":null,"endArrowhead":null,"points":[[0,0],[0.4682050427290587,345.4857547627121]],"index":"a1"},{"type":"arrow","version":185,"versionNonce":1485567626,"isDeleted":false,"id":"IyZzRZ5JqIHER-6F1-E5O","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-481.61313351761436,"y":-251.3182438184245,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":233.8535755342385,"height":124.39070236178819,"seed":723684984,"groupIds":[],"frameId":null,"roundness":{"type":2},"boundElements":[],"updated":1736852108450,"link":null,"locked":false,"startBinding":{"elementId":"oQsazDfp","focus":-0.12354746205183939,"gap":11.210937254852581},"endBinding":{"elementId":"YBBx1kpi","focus":-1.2657004041295234,"gap":9.986454223246085},"lastCommittedPoint":null,"startArrowhead":null,"endArrowhead":"arrow","points":[[0,0],[233.8535755342385,124.39070236178819]],"index":"a2"},{"type":"arrow","version":338,"versionNonce":1060900630,"isDeleted":false,"id":"Q1f5_MFrDfsecbVQuH-OD","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-247.48046963684098,"y":-127.48971240356306,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":227.2457650999838,"height":107.1965220286319,"seed":927141384,"groupIds":[],"frameId":null,"roundness":{"type":2},"boundElements":[],"updated":1736852108450,"link":null,"locked":false,"startBinding":{"elementId":"YBBx1kpi","focus":-0.15643074380383465,"gap":9.570431259324096},"endBinding":null,"lastCommittedPoint":null,"startArrowhead":null,"endArrowhead":"arrow","points":[[0,0],[-227.2457650999838,107.1965220286319]],"index":"a3"},{"type":"line","version":117,"versionNonce":1839240522,"isDeleted":false,"id":"JYITW6TxjmCNVtP2UDMdj","fillStyle":"solid","strokeWidth":2,"strokeStyle":"dotted","roughness":1,"opacity":100,"angle":0,"x":-592.4388342491441,"y":-253.5285645472374,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":485.0308056096036,"height":0,"seed":1090284808,"groupIds":[],"frameId":null,"roundness":{"type":2},"boundElements":[],"updated":1736852108450,"link":null,"locked":false,"startBinding":null,"endBinding":null,"lastCommittedPoint":null,"startArrowhead":null,"endArrowhead":null,"points":[[0,0],[485.0308056096036,0]],"index":"a4"},{"type":"line","version":179,"versionNonce":710261846,"isDeleted":false,"id":"DEe7VA_slo0t5N57u6vFs","fillStyle":"solid","strokeWidth":2,"strokeStyle":"dotted","roughness":1,"opacity":100,"angle":0,"x":-592.4388342491441,"y":-16.274869186257604,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":485.0308056096036,"height":0,"seed":2018977144,"groupIds":[],"frameId":null,"roundness":{"type":2},"boundElements":[],"updated":1736852108450,"link":null,"locked":false,"startBinding":null,"endBinding":null,"lastCommittedPoint":null,"startArrowhead":null,"endArrowhead":null,"points":[[0,0],[485.0308056096036,0]],"index":"a5"},{"type":"line","version":143,"versionNonce":473127946,"isDeleted":false,"id":"w1A1H6Jmr-Qx-UaDfkEi5","fillStyle":"solid","strokeWidth":2,"strokeStyle":"dotted","roughness":1,"opacity":100,"angle":0,"x":-592.4388342491441,"y":-129.2532958083759,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":485.0308056096036,"height":0,"seed":2014902904,"groupIds":[],"frameId":null,"roundness":{"type":2},"boundElements":[],"updated":1736852108450,"link":null,"locked":false,"startBinding":null,"endBinding":null,"lastCommittedPoint":null,"startArrowhead":null,"endArrowhead":null,"points":[[0,0],[485.0308056096036,0]],"index":"a6"},{"type":"rectangle","version":42,"versionNonce":2017968534,"isDeleted":false,"id":"kdN1aBzew8_dx9Gk-YmmA","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-554.9750512116466,"y":-363.63112100288,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":144.94727146582846,"height":55.48984750169427,"seed":150891640,"groupIds":[],"frameId":null,"roundness":{"type":3},"boundElements":[{"type":"text","id":"0IP9IQgo"}],"updated":1736852108450,"link":null,"locked":false,"index":"a7"},{"type":"text","version":12,"versionNonce":1648315082,"isDeleted":false,"id":"0IP9IQgo","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-513.4713912184499,"y":-348.38619725203284,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":61.93995147943497,"height":25,"seed":1349131640,"groupIds":[],"frameId":null,"roundness":null,"boundElements":[],"updated":1736852108450,"link":null,"locked":false,"fontSize":20,"fontFamily":1,"text":"Player","rawText":"Player","textAlign":"center","verticalAlign":"middle","containerId":"kdN1aBzew8_dx9Gk-YmmA","originalText":"Player","lineHeight":1.25,"baseline":17,"autoResize":true,"index":"a8"},{"type":"rectangle","version":63,"versionNonce":1548164822,"isDeleted":false,"id":"ifCKKnxgmblekN3bMty24","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-322.8901688378541,"y":-363.63112100288,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":144.94727146582846,"height":55.48984750169427,"seed":1375725320,"groupIds":[],"frameId":null,"roundness":{"type":3},"boundElements":[{"type":"text","id":"jMw5hP0o"}],"updated":1736852108450,"link":null,"locked":false,"index":"a9"},{"type":"text","version":41,"versionNonce":1180656010,"isDeleted":false,"id":"jMw5hP0o","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-281.67650456713,"y":-348.38619725203284,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":62.5199429243803,"height":25,"seed":1430242312,"groupIds":[],"frameId":null,"roundness":null,"boundElements":[],"updated":1736852108450,"link":null,"locked":false,"fontSize":20,"fontFamily":1,"text":"Server","rawText":"Server","textAlign":"center","verticalAlign":"middle","containerId":"ifCKKnxgmblekN3bMty24","originalText":"Server","lineHeight":1.25,"baseline":17,"autoResize":true,"index":"aA"},{"type":"text","version":80,"versionNonce":1525208086,"isDeleted":false,"id":"oQsazDfp","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-569.6364312700994,"y":-290.34364125900885,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":77.55996704101562,"height":35,"seed":280934408,"groupIds":[],"frameId":null,"roundness":null,"boundElements":[{"id":"IyZzRZ5JqIHER-6F1-E5O","type":"arrow"}],"updated":1736852108450,"link":null,"locked":false,"fontSize":28,"fontFamily":1,"text":"start","rawText":"start","textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"start","lineHeight":1.25,"baseline":24,"autoResize":true,"index":"aB"},{"type":"text","version":122,"versionNonce":1137614922,"isDeleted":false,"id":"v4iyiFIl","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-539.9001486910952,"y":-53.78696446405331,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":44.35198426246643,"height":35,"seed":19516936,"groupIds":[],"frameId":null,"roundness":null,"boundElements":[],"updated":1736852108450,"link":null,"locked":false,"fontSize":28,"fontFamily":1,"text":"end","rawText":"end","textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"end","lineHeight":1.25,"baseline":24,"autoResize":true,"index":"aC"},{"type":"text","version":103,"versionNonce":505536854,"isDeleted":false,"id":"QJRnCK1C","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-583.3129980889528,"y":53.28146095603694,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":442.96875,"height":33.6,"seed":1129991432,"groupIds":[],"frameId":null,"roundness":null,"boundElements":[],"updated":1736852108450,"link":null,"locked":false,"fontSize":28,"fontFamily":3,"text":"latency = (end - start) / 2","rawText":"latency = (end - start) / 2","textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"latency = (end - start) / 2","lineHeight":1.2,"baseline":27,"autoResize":true,"index":"aD"},{"type":"text","version":55,"versionNonce":912787210,"isDeleted":false,"id":"YBBx1kpi","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-238.1832385927404,"y":-164.76009770171402,"strokeColor":"#1e1e1e","backgroundColor":"transparent","width":46.36798095703125,"height":35,"seed":1289636616,"groupIds":[],"frameId":null,"roundness":null,"boundElements":[{"id":"IyZzRZ5JqIHER-6F1-E5O","type":"arrow"},{"id":"Q1f5_MFrDfsecbVQuH-OD","type":"arrow"}],"updated":1736852108450,"link":null,"locked":false,"fontSize":28,"fontFamily":1,"text":"ack","rawText":"ack","textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"ack","lineHeight":1.25,"baseline":24,"autoResize":true,"index":"aE"}],"appState":{"theme":"light","viewBackgroundColor":"#ffffff","currentItemStrokeColor":"#1e1e1e","currentItemBackgroundColor":"transparent","currentItemFillStyle":"solid","currentItemStrokeWidth":2,"currentItemStrokeStyle":"solid","currentItemRoughness":1,"currentItemOpacity":100,"currentItemFontFamily":3,"currentItemFontSize":28,"currentItemTextAlign":"left","currentItemStartArrowhead":null,"currentItemEndArrowhead":"arrow","currentItemArrowType":"round","scrollX":605.9661928537175,"scrollY":433.03872043182804,"zoom":{"value":1.914156},"currentItemRoundness":"round","gridSize":20,"gridStep":5,"gridModeEnabled":false,"gridColor":{"Bold":"rgba(217, 217, 217, 0.5)","Regular":"rgba(230, 230, 230, 0.5)"},"currentStrokeOptions":null,"frameRendering":{"enabled":true,"clip":true,"name":true,"outline":true},"objectsSnapModeEnabled":false,"activeTool":{"type":"selection","customType":null,"locked":false,"lastActiveTool":null}},"files":{}};InitialData.scrollToContent=true;App=()=>{const e=React.useRef(null),t=React.useRef(null),[n,i]=React.useState({width:void 0,height:void 0});return React.useEffect(()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height});const e=()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height})};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[t]),React.createElement(React.Fragment,null,React.createElement("div",{className:"excalidraw-wrapper",ref:t},React.createElement(ExcalidrawLib.Excalidraw,{ref:e,width:n.width,height:n.height,initialData:InitialData,viewModeEnabled:!0,zenModeEnabled:!0,gridModeEnabled:!1})))},excalidrawWrapper=document.getElementById("Drawing_2023-12-05_1924.48.excalidraw.md1");ReactDOM.render(React.createElement(App),excalidrawWrapper);})();</script>

![Pasted image 20231205193318.png](/img/user/docs/assets/Pasted%20image%2020231205193318.png)